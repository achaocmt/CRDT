%!TEX root = draft.tex

\section{Simulation Relation}
\label{sec:simulation relation}

In this section, we give our simulation relation between a implementation $\llbracket imp \rrbracket$ and a reference implementation (with causal delivery) $A$. Such simulation relation is via a function that maps messages into operations. For plus-minus specification and its compacted reference implementation $A'$, we give our simulation relation between $\llbracket imp \rrbracket$ and $A'$, and prove that from this simulation relation, we could obtain a simulation relation between $\llbracket imp \rrbracket$ and $A$, the non-compacted version of $A'$. 

Let $MtoO$ be the set of function that maps messages into operations. Given $\llbracket imp \rrbracket = (Q_{imp},\Sigma_{imp},\rightarrow_{imp},q_{0imp})$ and $RImp(Spec) = (Q_s,\Sigma_s,vis,q_{0s},li,\rightarrow_s,livReq)$, we say that $R \subseteq Q_{imp} \times Q_s$ is a simulation relation w.r.t $MtoO$, if given $(q_i,f,q_s) \in R$, we have that  

\begin{itemize}
\setlength{\itemsep}{0.5pt}
\item[-] $q_i {\xrightarrow{m(a,b,r)}}_{imp} q'_i$ and $m$ is a query method, then $\exists q'_s$, such that $q_s {\xrightarrow{m(a,b,r)}}_s q'_s$ and $(q'_i,f,q'_s)$. 

\item[-] $q_i {\xrightarrow{m(a,b,r)}}_{imp} q'_i$ and $m$ is an update method, then $\exists q'_s$, such that $q_s {\xrightarrow{m(a,b,r)}}_s q'_s$ and $(q'_i,f',q'_s)$. Here $f' = f \cup \{ (m,o) \vert m$ is newly added messages in $q'_i$ and $o$ is newly added operation in $q'_s\}$. 

\item[-] If $q_i {\xrightarrow{apply(m)}}_{imp} q'_i$, the destination replica of $m$ is replica $r$, and $f(m)=o$, then then $\exists q'_s$, such that $q_s {\xrightarrow{addDel(o,r)}}_s q'_s$ and $(q'_i,f,q'_s)$.
\end{itemize}

We say that a transition system is deterministic, if for each state $q$ and transition label $\alpha$, from $q$ there is at most one transition with label $\alpha$. {\color {red}It is safe to assume that when constructing reference implementation $RImp(Spec)$, in update operation transitions $q_s {\xrightarrow{m(a,b,r)}}_s q'_s$, we permit only one possible identifier of the newly added operation of $q'_i$. For example, each replica has a counter for generating unique identifier of operations. In this way, it is obvious that $RImp(Spec)$ is deterministic.} 






It is obvious that our simulation relation implies sequence inclusion (of operation and deliver). Since $RImp(Spec)$ is deterministic, according to \cite{Abadi:1991,Lynch:1995}, sequence inclusion also implies our simulation relation. This implies the following lemma: 

\begin{lemma}
\label{lemma:equivalence of our simulation relation and sequence inclusion}
A 
\end{lemma}




